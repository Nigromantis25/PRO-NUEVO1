<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - Tienda</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="../css/vendor.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />
    <link rel="stylesheet" type="text/css" href="../style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&family=Marcellus&display=swap"
      rel="stylesheet">
    <style>
      /* Ajustes locales para el layout del carrito */
      #cart-list { max-width:900px; margin:0 auto }
      .cart-item { display:flex; gap:16px; padding:16px; border-bottom:1px solid var(--muted,#eee); align-items:center }
      .cart-item img{ width:90px; height:auto; border-radius:6px }
      .cart-actions .btn{ margin-left:6px }
      #cart-total { font-size:1.25rem; font-weight:700 }
    </style>
  </head>
  <body>
    <!-- Header similar to main page -->
    <nav class="navbar navbar-expand-lg bg-light text-uppercase fs-6 p-3 border-bottom align-items-center">
      <div class="container-fluid">
        <div class="row justify-content-between align-items-center w-100">
          <div class="col-auto">
            <a class="navbar-brand text-white" href="../index.html">1807.Studio</a>
          </div>
          <div class="col-auto">
            <a href="../shop/cart.html" class="nav-link">CART <span class="cart-count">(0)</span></a>
            <span id="top-controls" class="ms-2"></span>
          </div>
        </div>
      </div>
    </nav>

    <main class="container mt-5">
      <section class="text-center mb-5">
        <h1 class="display-4" style="font-family:var(--heading-font);">Tu Carrito</h1>
        <p class="text-muted">Revisa los productos seleccionados y finaliza tu compra.</p>
      </section>

      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div id="cart-list" class="card p-3 mb-3">
            <!-- items renderizados por js -->
          </div>

          <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded">
            <div>
              <a href="../index.html" class="btn btn-outline-secondary">Seguir comprando</a>
            </div>
            <div class="text-end">
              <div id="cart-total" class="h5">Total: $0.00</div>
              <div class="mt-2">
                <button id="clear-cart" class="btn btn-sm btn-danger">Vaciar carrito</button>
                <button id="checkout" class="btn btn-sm btn-primary">Finalizar compra</button>
              </div>
            </div>
          </div>

          <!-- Checkout form (hidden until click) -->
          <div id="checkout-form" class="card p-4" style="display:none;">
            <h3 class="mb-3">Finalizar compra</h3>
            <form id="order-form">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Nombre completo</label>
                  <input class="form-control" type="text" name="customerName" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Email</label>
                  <input class="form-control" type="email" name="email" required>
                </div>
                <div class="col-12 mb-3">
                  <label class="form-label">Dirección de envío</label>
                  <input class="form-control" type="text" name="address" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Teléfono</label>
                  <input class="form-control" type="text" name="phone" required>
                </div>
              </div>
              <div class="text-end">
                <button type="submit" class="btn btn-success">Generar PDF de pedido</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoYz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script src="../js/cart.js"></script>
    <!-- jsPDF desde CDN para generar PDF en el cliente -->
    <script src="../js/theme.js"></script>
    <script>
      // Initialize theme toggle and adapt images if available
      window.themeHelpers && window.themeHelpers.init({ insertToggle: '#top-controls' });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
      // Renderizar la página del carrito usando la API expuesta por js/cart.js
      document.addEventListener('DOMContentLoaded', ()=>{
        const list = document.getElementById('cart-list')
        const totalEl = document.getElementById('cart-total')

        function renderPage(){
          const cart = (window.sdCart && window.sdCart.load()) || [];
          list.innerHTML = '';
          let total = 0;
          cart.forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = 'cart-item';
            const img = document.createElement('img');
            img.src = item.image || '';
            img.alt = item.name || '';
            const info = document.createElement('div');
            info.style.flex = '1';
            info.innerHTML = `<strong>${item.name}</strong><div>Cantidad: ${item.quantity || 1}</div>`;
            const actions = document.createElement('div');
            actions.className = 'cart-actions';
            actions.innerHTML = `<div style="text-align:right">${(item.price?('$'+Number(item.price).toFixed(2)):'$0.00')}</div>`;
            row.appendChild(img);
            row.appendChild(info);
            row.appendChild(actions);
            list.appendChild(row);
            total += (item.price || 0) * (item.quantity || 1);
          });
          totalEl.textContent = `Total: $${Number(total||0).toFixed(2)}`;
          document.querySelectorAll('.cart-count').forEach(el=>{ const c = cart.reduce((s,i)=>s+(i.quantity||1),0); el.textContent = `(${c})`; });
        }

        renderPage();
        // adapt images and apply stored theme
        window.themeHelpers && window.themeHelpers.adaptImages();

        document.getElementById('clear-cart').addEventListener('click', ()=>{
          if(confirm('¿Vaciar carrito?')){
            localStorage.removeItem('sd_cart')
            location.reload()
          }
        })

        document.getElementById('checkout').addEventListener('click', ()=>{
          document.getElementById('checkout-form').style.display = 'block'
          window.scrollTo({top: document.getElementById('checkout-form').offsetTop, behavior:'smooth'})
        })

        const orderForm = document.getElementById('order-form')
        orderForm.addEventListener('submit', async (e)=>{
          e.preventDefault()
          const formData = new FormData(orderForm)
          const data = Object.fromEntries(formData.entries())
          const cart = (window.sdCart && window.sdCart.load()) || []
          if(!cart.length) return alert('Tu carrito está vacío')

          // Generar PDF con formato más profesional
          const { jsPDF } = window.jspdf
          const doc = new jsPDF({ unit: 'pt', format: 'a4' })
          const margin = 40
          const pageWidth = doc.internal.pageSize.getWidth()
          let y = margin

          try{
            const logoUrl = '../images/1807-logo.svg'
            const img = new Image()
            img.crossOrigin = 'anonymous'
            img.src = logoUrl
            await new Promise((res,rej)=>{ img.onload = res; img.onerror = ()=>res() })
            if(img.width){
              doc.addImage(img, 'PNG', margin, y, 60, 60)
            }
          }catch(e){
            console.warn('No se pudo cargar el logo', e)
          }

          // Encabezado profesional: empresa a la izquierda, datos del pedido a la derecha
          const companyName = '1807.Studio';
          const companyAddr = 'C/ Ejemplo 123, Tocuyo';
          const fecha = new Date().toLocaleString();
          const invoiceNo = 'PED-' + Date.now().toString().slice(-6);

          doc.setFont('Helvetica', 'bold')
          doc.setFontSize(20)
          doc.text(companyName, margin, y)
          doc.setFontSize(10)
          doc.setFont('Helvetica', 'normal')
          doc.text(companyAddr, margin, y + 14)

          // Info del pedido a la derecha
          doc.setFontSize(10)
          doc.setFont('Helvetica', 'normal')
          doc.text(`Fecha: ${fecha}`, pageWidth - margin, y, { align: 'right' })
          doc.text(`Factura: ${invoiceNo}`, pageWidth - margin, y + 12, { align: 'right' })
          y += 36

          // Datos del cliente
          doc.setFont('Helvetica', 'bold')
          doc.setFontSize(12)
          doc.text('Datos del cliente', margin, y)
          y += 14
          doc.setFont('Helvetica', 'normal')
          doc.setFontSize(11)
          doc.text(`Nombre: ${data.customerName}`, margin, y)
          doc.text(`Email: ${data.email}`, pageWidth - margin, y, { align: 'right' })
          y += 14
          doc.text(`Dirección: ${data.address}`, margin, y)
          doc.text(`Tel: ${data.phone}`, pageWidth - margin, y, { align: 'right' })
          y += 20

          // Tabla productos: cabecera
          const tableX = margin
          const colWidths = [260, 60, 80, 80] // nombre, qty, unit, total
          doc.setFillColor(240,240,240)
          doc.rect(tableX - 6, y - 12, colWidths.reduce((a,b)=>a+b,0) + 12, 20, 'F')
          doc.setFont('Helvetica','bold')
          doc.setFontSize(11)
          doc.text('Producto', tableX, y)
          doc.text('Cant', tableX + colWidths[0], y)
          doc.text('Precio', tableX + colWidths[0] + colWidths[1], y)
          doc.text('Total', tableX + colWidths[0] + colWidths[1] + colWidths[2], y)
          y += 8
          doc.setDrawColor(200)
          y += 14
          doc.setFont('Helvetica','normal')
          let total = 0
          cart.forEach((item, idx) => {
            const qty = item.quantity || 1
            const unit = Number(item.price||0)
            const lineTotal = qty * unit
            total += lineTotal
            // Nombre (wrap si es largo)
            const name = item.name || 'Producto'
            doc.text(name, tableX, y)
            doc.text(String(qty), tableX + colWidths[0], y, { align: 'right' })
            doc.text(`$${unit.toFixed(2)}`, tableX + colWidths[0] + colWidths[1], y, { align: 'right' })
            doc.text(`$${lineTotal.toFixed(2)}`, tableX + colWidths[0] + colWidths[1] + colWidths[2], y, { align: 'right' })
            y += 16
            if(y > doc.internal.pageSize.getHeight() - 80){ doc.addPage(); y = margin }
          })

          // Total final
          y += 6
          doc.setFont('Helvetica','bold')
          doc.text(`Total: $${total.toFixed(2)}`, pageWidth - margin, y, { align: 'right' })

          // Nota y firma
          y += 30
          doc.setFont('Helvetica','normal')
          doc.setFontSize(10)
          doc.text('Gracias por tu compra. Si tienes dudas escribe a contacto@1807.studio', margin, y)

          doc.save(`${invoiceNo}.pdf`)
          alert('Gracias por tu compra. Se ha generado un PDF con tu pedido.')
          localStorage.removeItem('sd_cart')
          location.reload()
        })
      })
    </script>
  </body>
</html>